<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

  <changeSet id="1-create-analytics-schema" author="mh">
    <createTable tableName="dim_event_type">
      <column name="event_type_key" type="tinyint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="event_type" type="varchar(128)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="dim_unit">
      <column name="unit_key" type="mediumint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="hsa_id" type="varchar(64)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="dim_role">
      <column name="role_key" type="tinyint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="role" type="varchar(32)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="dim_user">
      <column name="user_key" type="mediumint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="user_id" type="varchar(22)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="dim_care_provider">
      <column name="care_provider_key" type="smallint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="hsa_id" type="varchar(64)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="dim_session">
      <column name="session_key" type="int unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="session_id" type="varchar(22)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="dim_origin">
      <column name="origin_key" type="tinyint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="origin" type="varchar(20)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="dim_patient">
      <column name="patient_key" type="mediumint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="patient_id" type="varchar(22)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="dim_certificate">
      <column name="certificate_key" type="int unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="certificate_id" type="varchar(22)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="certificate_type" type="varchar(24)">
        <constraints nullable="false"/>
      </column>
      <column name="certificate_type_version" type="varchar(24)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createTable tableName="dim_party">
      <column name="party_key" type="tinyint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="party_id" type="varchar(32)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="dim_message">
      <column name="message_key" type="int unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="message_id" type="varchar(22)">
        <constraints nullable="false"/>
      </column>
      <column name="message_answer_id" type="varchar(22)">
        <constraints unique="true"/>
      </column>
      <column name="message_reminder_id" type="varchar(22)">
        <constraints unique="true"/>
      </column>
      <column name="message_type" type="varchar(24)">
        <constraints nullable="false"/>
      </column>
      <column name="complement_first_question_id" type="varchar(32)"/>
      <column name="complement_second_question_id" type="varchar(32)"/>
      <column name="complement_third_question_id" type="varchar(32)"/>
      <column name="complement_fourth_question_id" type="varchar(32)"/>
      <column name="complement_fifth_question_id" type="varchar(32)"/>
      <column name="complement_sixth_question_id" type="varchar(32)"/>
      <column name="complement_seventh_question_id" type="varchar(32)"/>
      <column name="sent" type="timestamp(6)">
        <constraints nullable="false"/>
      </column>
      <column name="last_date_to_answer" type="date"/>
    </createTable>

    <createTable tableName="dim_relation_type">
      <column name="relation_type_key" type="tinyint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="relation_type" type="varchar(64)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="fact_event">
      <column name="event_key" type="bigint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="timestamp" type="datetime">
        <constraints nullable="false"/>
      </column>
      <column name="event_type_key" type="tinyint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="certificate_key" type="int unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="parent_relation_certificate_key" type="int unsigned"/>
      <column name="parent_relation_type_key" type="tinyint unsigned"/>
      <column name="certificate_unit_key" type="mediumint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="certificate_care_provider_key" type="smallint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="patient_key" type="mediumint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="message_key" type="int unsigned"/>
      <column name="message_complement_question_ids_count" type="tinyint unsigned"/>
      <column name="user_key" type="mediumint unsigned"/>
      <column name="role_key" type="tinyint unsigned"/>
      <column name="origin_key" type="tinyint unsigned"/>
      <column name="session_key" type="int unsigned"/>
      <column name="unit_key" type="mediumint unsigned"/>
      <column name="care_provider_key" type="smallint unsigned"/>
      <column name="sender_party_key" type="tinyint unsigned"/>
      <column name="recipient_party_key" type="tinyint unsigned"/>
      <column name="id" type="varchar(22)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="certificate_key"
      referencedTableName="dim_certificate" referencedColumnNames="certificate_key"
      constraintName="fk_event_certificate"/>
    <addForeignKeyConstraint baseTableName="fact_event"
      baseColumnNames="parent_relation_certificate_key"
      referencedTableName="dim_certificate" referencedColumnNames="certificate_key"
      constraintName="fk_event_parent_relation_certificate"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="parent_relation_type_key"
      referencedTableName="dim_relation_type" referencedColumnNames="relation_type_key"
      constraintName="fk_event_parent_relation_type"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="certificate_unit_key"
      referencedTableName="dim_unit" referencedColumnNames="unit_key"
      constraintName="fk_event_certificate_unit"/>
    <addForeignKeyConstraint baseTableName="fact_event"
      baseColumnNames="certificate_care_provider_key"
      referencedTableName="dim_care_provider" referencedColumnNames="care_provider_key"
      constraintName="fk_event_certificate_care_provider"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="unit_key"
      referencedTableName="dim_unit" referencedColumnNames="unit_key"
      constraintName="fk_event_unit"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="care_provider_key"
      referencedTableName="dim_care_provider" referencedColumnNames="care_provider_key"
      constraintName="fk_event_care_provider"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="user_key"
      referencedTableName="dim_user" referencedColumnNames="user_key"
      constraintName="fk_event_user"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="session_key"
      referencedTableName="dim_session" referencedColumnNames="session_key"
      constraintName="fk_event_session"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="origin_key"
      referencedTableName="dim_origin" referencedColumnNames="origin_key"
      constraintName="fk_event_origin"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="event_type_key"
      referencedTableName="dim_event_type" referencedColumnNames="event_type_key"
      constraintName="fk_event_event_type"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="role_key"
      referencedTableName="dim_role" referencedColumnNames="role_key"
      constraintName="fk_event_role"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="sender_party_key"
      referencedTableName="dim_party" referencedColumnNames="party_key"
      constraintName="fk_event_sender_party"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="recipient_party_key"
      referencedTableName="dim_party" referencedColumnNames="party_key"
      constraintName="fk_event_recipient_party"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="message_key"
      referencedTableName="dim_message" referencedColumnNames="message_key"
      constraintName="fk_event_message"/>
    <addForeignKeyConstraint baseTableName="fact_event" baseColumnNames="patient_key"
      referencedTableName="dim_patient" referencedColumnNames="patient_key"
      constraintName="fk_event_patient"/>
  </changeSet>

  <changeSet id="remove-unique-message-reminder-id" author="cs">
    <dropUniqueConstraint
      tableName="dim_message"
      constraintName="message_reminder_id"/>
  </changeSet>
</databaseChangeLog>