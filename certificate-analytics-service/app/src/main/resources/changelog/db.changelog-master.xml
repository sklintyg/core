<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

  <changeSet id="1-create-analytics-schema" author="mh">
    <createTable tableName="event_type">
      <column name="key" type="tinyint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="event_type" type="varchar(128)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="unit">
      <column name="key" type="bigint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="hsa_id" type="varchar(64)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="role">
      <column name="key" type="tinyint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="role" type="varchar(32)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="user">
      <column name="key" type="bigint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="user_id" type="varchar(22)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="care_provider">
      <column name="key" type="bigint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="hsa_id" type="varchar(64)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="session">
      <column name="key" type="bigint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="session_id" type="varchar(22)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="origin">
      <column name="key" type="tinyint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="origin" type="varchar(20)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="certificate_type">
      <column name="key" type="bigint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="certificate_type" type="varchar(24)">
        <constraints nullable="false"/>
      </column>
      <column name="certificate_type_version" type="varchar(24)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addUniqueConstraint tableName="certificate_type"
      columnNames="certificate_type,certificate_type_version"
      constraintName="uk_certificate_type_type_version"/>

    <createTable tableName="patient">
      <column name="key" type="bigint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="patient_id" type="varchar(22)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="certificate">
      <column name="key" type="bigint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="certificate_id" type="varchar(22)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="certificate_type_key" type="bigint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="patient_key" type="bigint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="unit_key" type="bigint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="care_provider_key" type="bigint unsigned">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseTableName="certificate" baseColumnNames="certificate_type_key"
      referencedTableName="certificate_type" referencedColumnNames="key"
      constraintName="fk_certificate_certificate_type"/>
    <addForeignKeyConstraint baseTableName="certificate" baseColumnNames="care_provider_key"
      referencedTableName="care_provider" referencedColumnNames="key"
      constraintName="fk_certificate_care_provider"/>
    <addForeignKeyConstraint baseTableName="certificate" baseColumnNames="unit_key"
      referencedTableName="unit" referencedColumnNames="key"
      constraintName="fk_certificate_unit"/>
    <addForeignKeyConstraint baseTableName="certificate" baseColumnNames="patient_key"
      referencedTableName="patient" referencedColumnNames="key"
      constraintName="fk_certificate_patient"/>

    <createTable tableName="recipient">
      <column name="key" type="tinyint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="recipient" type="varchar(32)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="administrative_message_sender">
      <column name="key" type="tinyint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="sender" type="varchar(32)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="administrative_message_recipient">
      <column name="key" type="tinyint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="recipient" type="varchar(32)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="administrative_message_type">
      <column name="key" type="tinyint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="type" type="varchar(24)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="administrative_message">
      <column name="key" type="bigint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="administrative_message_id" type="varchar(22)">
        <constraints nullable="false"/>
      </column>
      <column name="answer_id" type="varchar(22)">
        <constraints unique="true"/>
      </column>
      <column name="reminder_id" type="varchar(22)">
        <constraints unique="true"/>
      </column>
      <column name="administrative_message_type_key" type="tinyint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="sent" type="timestamp(6)">
        <constraints nullable="false"/>
      </column>
      <column name="last_date_to_answer" type="date"/>
      <column name="administrative_message_sender_key" type="tinyint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="administrative_message_recipient_key" type="tinyint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="message_id" type="varchar(22)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <createTable tableName="administrative_message_question_id">
      <column name="administrative_message_key" type="bigint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="question_id" type="varchar(5)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseTableName="administrative_message_question_id"
      baseColumnNames="administrative_message_key"
      referencedTableName="administrative_message" referencedColumnNames="key"
      constraintName="fk_administrative_message_question_message"/>

    <addUniqueConstraint tableName="administrative_message_question_id"
      columnNames="administrative_message_key,question_id"
      constraintName="uk_administrative_message_question"/>

    <createTable tableName="event">
      <column name="key" type="bigint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="timestamp" type="timestamp(6)">
        <constraints nullable="false"/>
      </column>
      <column name="event_type_key" type="tinyint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="certificate_key" type="bigint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="administrative_message_key" type="bigint unsigned"/>
      <column name="user_key" type="bigint unsigned"/>
      <column name="role_key" type="tinyint unsigned"/>
      <column name="origin_key" type="tinyint unsigned"/>
      <column name="session_key" type="bigint unsigned"/>
      <column name="unit_key" type="bigint unsigned"/>
      <column name="provider_key" type="bigint unsigned"/>
      <column name="recipient_key" type="tinyint unsigned"/>
      <column name="message_id" type="varchar(22)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseTableName="event" baseColumnNames="certificate_key"
      referencedTableName="certificate" referencedColumnNames="key"
      constraintName="fk_event_certificate"/>
    <addForeignKeyConstraint baseTableName="event" baseColumnNames="unit_key"
      referencedTableName="unit" referencedColumnNames="key"
      constraintName="fk_event_unit"/>
    <addForeignKeyConstraint baseTableName="event" baseColumnNames="provider_key"
      referencedTableName="care_provider" referencedColumnNames="key"
      constraintName="fk_event_provider"/>
    <addForeignKeyConstraint baseTableName="event" baseColumnNames="user_key"
      referencedTableName="user" referencedColumnNames="key"
      constraintName="fk_event_user"/>
    <addForeignKeyConstraint baseTableName="event" baseColumnNames="session_key"
      referencedTableName="session" referencedColumnNames="key"
      constraintName="fk_event_session"/>
    <addForeignKeyConstraint baseTableName="event" baseColumnNames="origin_key"
      referencedTableName="origin" referencedColumnNames="key"
      constraintName="fk_event_origin"/>
    <addForeignKeyConstraint baseTableName="event" baseColumnNames="event_type_key"
      referencedTableName="event_type" referencedColumnNames="key"
      constraintName="fk_event_event_type"/>
    <addForeignKeyConstraint baseTableName="event" baseColumnNames="role_key"
      referencedTableName="role" referencedColumnNames="key"
      constraintName="fk_event_role"/>
    <addForeignKeyConstraint baseTableName="event" baseColumnNames="recipient_key"
      referencedTableName="recipient" referencedColumnNames="key"
      constraintName="fk_event_recipient"/>
    <addForeignKeyConstraint baseTableName="event" baseColumnNames="administrative_message_key"
      referencedTableName="administrative_message" referencedColumnNames="key"
      constraintName="fk_event_administrative_message"/>

    <createTable tableName="certificate_relation">
      <column name="key" type="bigint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="parent_certificate_key" type="bigint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="child_certificate_key" type="bigint unsigned">
        <constraints nullable="false"/>
      </column>
      <column name="certificate_relation_type_key" type="bigint unsigned">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createTable tableName="certificate_relation_type">
      <column name="key" type="bigint unsigned auto_increment">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="relation_type" type="varchar(64)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseTableName="certificate_relation"
      baseColumnNames="parent_certificate_key"
      referencedTableName="certificate" referencedColumnNames="key"
      constraintName="fk_certificate_relation_parent_certificate"/>
    <addForeignKeyConstraint baseTableName="certificate_relation"
      baseColumnNames="child_certificate_key"
      referencedTableName="certificate" referencedColumnNames="key"
      constraintName="fk_certificate_relation_child_certificate"/>
    <addForeignKeyConstraint baseTableName="certificate_relation"
      baseColumnNames="certificate_relation_type_key"
      referencedTableName="certificate_relation_type" referencedColumnNames="key"
      constraintName="fk_certificate_relation_type"/>

    <addUniqueConstraint tableName="certificate_relation"
      columnNames="parent_certificate_key,child_certificate_key"
      constraintName="uk_certificate_relation_parent_child"/>
  </changeSet>

</databaseChangeLog>